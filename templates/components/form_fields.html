{% macro number_field(name, value, label, unit='', min=None, max=None) %}
<div class="mb-2">
    <label class="form-label small fw-bold text-secondary mb-0">{{ label }}</label>
    <div class="input-group input-group-sm">
        <input type="number" class="form-control" name="{{ name }}" value="{{ value }}" {% if min is not none
            %}min="{{ min }}" {% endif %} {% if max is not none %}max="{{ max }}" {% endif %} step="any">
        {% if unit %}<span class="input-group-text">{{ unit }}</span>{% endif %}
    </div>
</div>
{% endmacro %}

{% macro text_field(name, value, label) %}
<div class="mb-2">
    <label class="form-label small fw-bold text-secondary mb-0">{{ label }}</label>
    <input type="text" class="form-control form-control-sm" name="{{ name }}" value="{{ value }}">
</div>
{% endmacro %}

{% macro range_field(name, value, label, unit='') %}
<div class="mb-2">
    <label class="form-label small fw-bold text-secondary mb-0">{{ label }}</label>
    <div class="input-group input-group-sm">
        <span class="input-group-text">Min</span>
        <input type="number" class="form-control" name="{{ name }}_min" value="{{ value[0] }}" step="any">
        <span class="input-group-text">Max</span>
        <input type="number" class="form-control" name="{{ name }}_max" value="{{ value[1] }}" step="any">
        {% if unit %}<span class="input-group-text">{{ unit }}</span>{% endif %}
    </div>
</div>
{% endmacro %}

{# ========================================== #}
{# 2. COMPLEX FIELDS #}
{# ========================================== #}

{% macro dict_field(name, value, label) %}
<div class="card mb-3 border-0 bg-light">
    <div class="card-body py-2">
        <label class="form-label fw-bold text-primary mb-2">{{ label }}</label>
        <div class="ps-3 border-start border-3 border-primary-subtle">
            {% for key, val in value.items() %}
            {# FIX: Use ~ to concatenate string + key safely #}
            {% set sub_name = name ~ '.' ~ key %}

            <div class="mb-2">
                <label class="form-label small text-muted mb-0">{{ key | replace('_', ' ') | title }}</label>
                {% if val is number %}
                <input type="number" class="form-control form-control-sm" name="{{ sub_name }}" value="{{ val }}"
                    step="any">
                {% else %}
                <input type="text" class="form-control form-control-sm" name="{{ sub_name }}" value="{{ val }}">
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endmacro %}

{% macro list_field(name, value, label) %}
<div class="card mb-3 border-0 bg-light">
    <div class="card-body py-2">
        <label class="form-label fw-bold text-success mb-2">{{ label }}</label>
        <div class="ps-3 border-start border-3 border-success-subtle">
            {% for val in value %}
            {# FIX: Use ~ to concatenate string + integer safely #}
            {% set sub_name = name ~ '.' ~ loop.index0 %}

            <div class="input-group input-group-sm mb-2">
                <span class="input-group-text text-muted">#{{ loop.index }}</span>
                {% if val is number %}
                <input type="number" class="form-control" name="{{ sub_name }}" value="{{ val }}" step="any">
                {% else %}
                <input type="text" class="form-control" name="{{ sub_name }}" value="{{ val }}">
                {% endif %}
            </div>
            {% endfor %}
            <div class="form-text small">
                <i class="bi bi-info-circle"></i> List size is fixed (editing only)
            </div>
        </div>
    </div>
</div>
{% endmacro %}



{# ========================================== #}
{# 3. MAIN RENDER LOOP #}
{# ========================================== #}

{% macro render_dynamic_fields(schema, data_obj, parent_path='') %}
{% for field_key, meta in schema.items() %}
{% set field_path = (parent_path + '.' + field_key) if parent_path else field_key %}

{# Safety check: ensure data_obj has the key, otherwise skip or use default #}
{% if data_obj is mapping and field_key in data_obj %}
{% set current_value = data_obj[field_key] %}

{# 1. GROUPS (Recursive) #}
{% if meta.type == 'group' %}
<div class="card mb-3 bg-light border-0 ms-2">
    <div class="card-body pt-2 pb-2">
        <h6 class="text-primary text-uppercase fs-6 fw-bold mb-2 border-bottom pb-1">
            {{ meta.label }}
        </h6>
        {{ render_dynamic_fields(meta.sub_schema, current_value, field_path) }}
    </div>
</div>

{# 2. DICTIONARIES #}
{% elif current_value is mapping %}
{{ dict_field(field_path, current_value, meta.label) }}

{# 3. LISTS (Iterable but not string) #}
{% elif current_value is iterable and current_value is not string %}
{{ list_field(field_path, current_value, meta.label) }}

{# 4. NUMBERS #}
{% elif meta.type == 'integer' or meta.type == 'number' or current_value is number %}
{{ number_field(field_path, current_value, meta.label, meta.unit) }}

{# 5. FALLBACK (TEXT) #}
{% else %}
{{ text_field(field_path, current_value, meta.label) }}
{% endif %}
{% endif %}
{% endfor %}
{% endmacro %}