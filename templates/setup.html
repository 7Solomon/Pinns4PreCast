{% extends "base.html" %}
{% from "components/form_fields.html" import number_field, text_field, range_field, render_dynamic_fields, json_field %}

{% block title %}Configuration Setup{% endblock %}

{% block content %}

{% macro render_accordion_item(index, type, filename, data, active_filename, schema) %}
<div class="accordion-item">
    <h2 class="accordion-header">
        <button class="accordion-button collapsed {% if filename == active_filename %}bg-success-subtle{% endif %}"
            type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ type }}-{{ index }}">
            {{ filename }}
            {% if filename == active_filename %}
            <span class="badge bg-success ms-2">Active</span>
            {% endif %}
        </button>
    </h2>
    <div id="collapse-{{ type }}-{{ index }}" class="accordion-collapse collapse"
        data-bs-parent="#accordion{{ type|capitalize }}">
        <div class="accordion-body">
            <!-- IMPORTANT: onsubmit calls our custom JS -->
            <form onsubmit="saveInline(event, '{{ type }}', '{{ filename }}')">

                <!-- This renders all inputs, including the new JSON fields -->
                {{ render_dynamic_fields(schema, data) }}

                <div class="accordion-actions d-flex gap-2 mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-success flex-grow-1">ðŸ’¾ Save Changes</button>
                    <button type="button" class="btn btn-primary flex-grow-1"
                        onclick="setActive('{{ type }}', '{{ filename }}')">âœ“ Set Active</button>
                    <button type="button" class="btn btn-outline-danger"
                        onclick="deleteFile('{{ type }}', '{{ filename }}')">ðŸ—‘ Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endmacro %}

{# ================================================================= #}
{# MAIN PAGE CONTENT #}
{# ================================================================= #}

<!-- 1. EXTERNAL LIBRARIES -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.10.2/jsoneditor.min.css" rel="stylesheet"
    type="text/css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/setup.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.10.2/jsoneditor.min.js"></script>

<!-- 2. HEADER -->
<div class="content-header mb-4">
    <h1>Configuration Setup</h1>
    <p class="text-muted">Configure parameters, material properties, and domain settings</p>
</div>

<!-- 3. ACTIVE STATE DISPLAY -->
<div class="alert alert-info d-flex align-items-center mb-4 shadow-sm">
    <div class="me-3"><strong>Active Configuration:</strong></div>
    <div class="d-flex gap-3 flex-wrap">
        <span class="badge bg-primary p-2">Config: {{ current_state.config }}</span>
        <span class="badge bg-success p-2">Material: {{ current_state.material }}</span>
        <span class="badge bg-info p-2">Domain: {{ current_state.domain }}</span>
    </div>
</div>

<!-- 4. TABS NAVIGATION -->
<ul class="nav nav-tabs" id="configTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#tab-config" type="button"
            role="tab">
            Configuration
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="material-tab" data-bs-toggle="tab" data-bs-target="#tab-material" type="button"
            role="tab">
            Material
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="domain-tab" data-bs-toggle="tab" data-bs-target="#tab-domain" type="button"
            role="tab">
            Domain
        </button>
    </li>
</ul>

<!-- 5. TAB CONTENT WRAPPER -->
<div class="tab-content card shadow-sm border-top-0" id="configTabContent" style="min-height: 500px;">

    <!-- TAB 1: CONFIG -->
    <div class="tab-pane fade show active" id="tab-config" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
            <h5 class="mb-0">Configuration Files</h5>
            <button class="btn btn-success btn-sm" onclick="createNew('config')">+ Add New</button>
        </div>
        <div class="accordion accordion-flush" id="accordionConfig">
            {% for filename, data in options_data['config'].items() %}
            {{ render_accordion_item(loop.index, 'config', filename, data, current_state.config, config_schema) }}
            {% endfor %}
        </div>
    </div>

    <!-- TAB 2: MATERIAL -->
    <div class="tab-pane fade" id="tab-material" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
            <h5 class="mb-0">Material Files</h5>
            <button class="btn btn-success btn-sm" onclick="createNew('material')">+ Add New</button>
        </div>
        <div class="accordion accordion-flush" id="accordionMaterial">
            {% for filename, data in options_data['material'].items() %}
            {{ render_accordion_item(loop.index, 'material', filename, data, current_state.material, material_schema) }}
            {% endfor %}
        </div>
    </div>

    <!-- TAB 3: DOMAIN -->
    <div class="tab-pane fade" id="tab-domain" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
            <h5 class="mb-0">Domain Files</h5>
            <button class="btn btn-success btn-sm" onclick="createNew('domain')">+ Add New</button>
        </div>
        <div class="accordion accordion-flush" id="accordionDomain">
            {% for filename, data in options_data['domain'].items() %}
            {{ render_accordion_item(loop.index, 'domain', filename, data, current_state.domain, domain_schema) }}
            {% endfor %}
        </div>
    </div>

</div>

{% endblock %}


{% block scripts %}
<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const jsonEditors = {};

    document.addEventListener('DOMContentLoaded', function () {
        const containers = document.querySelectorAll('.json-editor-container');

        containers.forEach(container => {
            const fieldName = container.dataset.fieldName;
            const hiddenInput = container.parentElement.querySelector(`input[name="${fieldName}"]`);

            if (!hiddenInput) return;

            let initialValue = {};
            try {
                initialValue = JSON.parse(hiddenInput.value);
            } catch (e) {
                console.error(`Invalid JSON for ${fieldName}`, e);
            }

            const options = {
                mode: 'tree',
                modes: ['tree', 'code'],
                search: true,
                mainMenuBar: true,
                navigationBar: false,
                statusBar: false,
                onChangeText: function (jsonString) {
                    hiddenInput.value = jsonString;
                }
            };

            const editor = new JSONEditor(container, options);
            editor.set(initialValue);
            jsonEditors[fieldName] = editor;
        });
    });
    function fixArrays(obj) {
        if (typeof obj !== 'object' || obj === null) return obj;

        // Check if object keys look like "0", "1", "2"...
        const keys = Object.keys(obj).sort((a, b) => a - b);
        const isArrayLike = keys.length > 0 && keys.every((k, i) => String(k) === String(i));

        if (isArrayLike) {
            // Convert to Array and recurse
            const newArr = [];
            keys.forEach(k => {
                newArr.push(fixArrays(obj[k]));
            });
            return newArr;
        }

        // Otherwise just recurse through object properties
        for (let k in obj) {
            obj[k] = fixArrays(obj[k]);
        }
        return obj;
    }
    function saveInline(event, type, filename) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const content = {};

        for (let [key, value] of formData.entries()) {
            // Handle JSON Fields
            if (jsonEditors[key]) {
                try {
                    const jsonValue = jsonEditors[key].get();
                    setNestedValue(content, key, jsonValue);
                } catch (e) {
                    alert(`Error in JSON field '${key}':\n${e.message}`);
                    return;
                }
            }
            // Handle Range Fields
            else if (key.endsWith('_min')) {
                const baseKey = key.replace('_min', '');
                const max = formData.get(baseKey + '_max');
                setNestedValue(content, baseKey, [parseFloat(value), parseFloat(max)]);
            }
            // Handle Standard Fields
            else if (!key.endsWith('_max')) {
                const inputElement = event.target.querySelector(`[name="${key}"]`);
                const isNumber = inputElement && inputElement.type === 'number';
                let parsedValue = value;
                if (isNumber && value !== "") {
                    parsedValue = parseFloat(value);
                }
                setNestedValue(content, key, parsedValue);
            }
            else {
                setNestedValue(content, key, value);
            }
        }
        content = fixArrays(content);

        fetch('/info/save_config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, filename, content })
        })
            .then(r => r.json())
            .then(data => {
                if (data.error) alert("Error: " + data.error);
                else showToast("âœ“ Saved successfully!", "success");
            })
            .catch(err => alert("Network Error: " + err));
    }

    function setNestedValue(obj, path, value) {
        const keys = path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length - 1; i++) {
            if (!current[keys[i]]) current[keys[i]] = {};
            current = current[keys[i]];
        }
        current[keys[keys.length - 1]] = value;
    }

    function setActive(type, filename) {
        const payload = { [type]: filename };
        fetch('/info/load_state', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(() => {
                showToast("âœ“ Active state updated!", "success");
                setTimeout(() => location.reload(), 800);
            })
            .catch(err => alert("Error: " + err));
    }

    function createNew(type) {
        const name = prompt(`Enter new ${type} filename (without .json):`);
        if (!name) return;

        fetch(`/info/defaults/${type}`)
            .then(r => r.json())
            .then(defaults => {
                return fetch('/info/save_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, filename: name, content: defaults })
                });
            })
            .then(r => r.json())
            .then(() => {
                showToast("âœ“ Created successfully!", "success");
                setTimeout(() => location.reload(), 1000);
            })
            .catch(err => alert("Error: " + err));
    }

    function deleteFile(type, filename) {
        if (!confirm(`Delete ${filename}? This cannot be undone.`)) return;
        fetch(`/info/delete_config/${type}/${filename}`, { method: 'DELETE' })
            .then(() => location.reload())
            .catch(err => alert("Error: " + err));
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} shadow-lg`;
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '10000';
        toast.style.minWidth = '300px';
        toast.innerHTML = `<strong>${message}</strong><button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
{% endblock %}